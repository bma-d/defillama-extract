<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>1</storyId>
    <title>Implement Base HTTP Client with Timeout and User-Agent</title>
    <status>drafted</status>
    <generatedAt>2025-11-30</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/2-1-implement-base-http-client-with-timeout-and-user-agent.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer</asA>
    <iWant>a configured HTTP client with proper timeout and identification headers</iWant>
    <soThat>API requests are well-behaved and identifiable to DefiLlama's servers</soThat>
    <tasks>
      <task id="1" desc="Create Client struct and constructor" acs="1,2,4">
        <subtask id="1.1">Create internal/api/client.go file</subtask>
        <subtask id="1.2">Define Client struct with fields: httpClient *http.Client, baseURL string, userAgent string, maxRetries int, retryDelay time.Duration, logger *slog.Logger</subtask>
        <subtask id="1.3">Implement NewClient(cfg *config.APIConfig, logger *slog.Logger) *Client constructor</subtask>
        <subtask id="1.4">Set http.Client.Timeout from cfg.Timeout (default 30s)</subtask>
        <subtask id="1.5">Store User-Agent string as defillama-extract/1.0</subtask>
      </task>
      <task id="2" desc="Implement request helper with User-Agent injection" acs="2,3,5">
        <subtask id="2.1">Create doRequest(ctx context.Context, url string, target any) error method</subtask>
        <subtask id="2.2">Use http.NewRequestWithContext(ctx, GET, url, nil) for context support</subtask>
        <subtask id="2.3">Set req.Header.Set(User-Agent, c.userAgent) on all requests</subtask>
        <subtask id="2.4">Execute request with c.httpClient.Do(req) and check for errors</subtask>
        <subtask id="2.5">Decode response body with json.NewDecoder(resp.Body).Decode(target)</subtask>
        <subtask id="2.6">Close response body in defer statement</subtask>
      </task>
      <task id="3" desc="Write unit tests for client initialization" acs="1,4">
        <subtask id="3.1">Create internal/api/client_test.go file</subtask>
        <subtask id="3.2">Test NewClient sets correct timeout from config</subtask>
        <subtask id="3.3">Test NewClient stores User-Agent string correctly</subtask>
        <subtask id="3.4">Test NewClient handles nil logger (should use slog.Default)</subtask>
      </task>
      <task id="4" desc="Write integration tests with mock server" acs="2,3,5">
        <subtask id="4.1">Test User-Agent header is present using httptest.NewServer</subtask>
        <subtask id="4.2">Test timeout behavior with delayed mock server response</subtask>
        <subtask id="4.3">Test context cancellation aborts request</subtask>
        <subtask id="4.4">Test successful JSON decode into target struct</subtask>
      </task>
      <task id="5" desc="Verification" acs="all">
        <subtask id="5.1">Run go build ./... and verify success</subtask>
        <subtask id="5.2">Run go test ./internal/api/... and verify all pass</subtask>
        <subtask id="5.3">Run make lint and verify no errors</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <ac id="1">Given API configuration with timeout: 30s When the HTTP client is initialized via NewClient(cfg, logger) Then the underlying *http.Client uses a 30-second timeout</ac>
    <ac id="2">Given any HTTP request made by the client When the request is sent Then the User-Agent header is set to defillama-extract/1.0</ac>
    <ac id="3">Given an API request in progress When the timeout duration elapses without response Then the request is cancelled And returns an error indicating timeout occurred</ac>
    <ac id="4">Given valid *config.APIConfig and *slog.Logger When NewClient(cfg, logger) is called Then a properly configured *Client is returned with the timeout and User-Agent applied</ac>
    <ac id="5">Given a context with cancellation When the context is cancelled during a request Then the request is aborted and returns context.Canceled error</ac>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/prd.md" title="Product Requirements Document" section="API Integration (FR1-FR8)" snippet="FR4: System includes proper User-Agent header identifying the extractor. FR6: System respects configurable timeout for API requests (default 30s)." />
      <doc path="docs/sprint-artifacts/tech-spec-epic-2.md" title="Epic 2 Technical Specification" section="Detailed Design" snippet="Client struct definition with httpClient, baseURL, userAgent, maxRetries, retryDelay, logger fields. Constructor NewClient(cfg, logger) creates configured client." />
      <doc path="docs/epics/epic-2-api-integration.md" title="Epic 2: API Integration" section="Story 2.1" snippet="As a developer, I want a configured HTTP client with proper timeout and identification headers. Package: internal/api/client.go." />
      <doc path="docs/architecture/architecture-decision-records-adrs.md" title="ADRs" section="ADR-001" snippet="Use net/http for HTTP (no external frameworks). ADR-004: Use log/slog for structured logging. ADR-005: Minimal external dependencies." />
      <doc path="docs/architecture/testing-strategy.md" title="Testing Strategy" section="Test Organization" snippet="Mock Server Tests in internal/api/client_test.go using httptest. Test fixtures in testdata/ directory." />
      <doc path="docs/architecture/project-structure.md" title="Project Structure" section="internal/api/" snippet="client.go (HTTP client with retry logic), client_test.go (Client tests with mock server), endpoints.go, responses.go." />
      <doc path="docs/architecture/implementation-patterns.md" title="Implementation Patterns" section="Context Propagation" snippet="All I/O functions accept context.Context as first parameter. Use http.NewRequestWithContext for cancellation support." />
    </docs>
    <code>
      <code path="internal/config/config.go" kind="config" symbol="APIConfig" lines="29-35" reason="Contains Timeout, MaxRetries, RetryDelay, OraclesURL, ProtocolsURL fields that Client must consume" />
      <code path="internal/logging/logging.go" kind="logging" symbol="Setup" lines="13-15" reason="Returns configured *slog.Logger that Client constructor accepts" />
      <code path="internal/api/doc.go" kind="placeholder" symbol="package api" lines="1-2" reason="Package already exists; client.go will be added here" />
      <code path="cmd/extractor/main.go" kind="entrypoint" symbol="main" reason="Future consumer of api.NewClient once wired up" />
    </code>
    <dependencies>
      <go version="1.23" />
      <require name="gopkg.in/yaml.v3" version="v3.0.1" purpose="YAML config parsing (existing)" />
      <stdlib name="net/http" purpose="HTTP client and request handling (this story)" />
      <stdlib name="context" purpose="Request cancellation and timeout propagation" />
      <stdlib name="encoding/json" purpose="JSON response decoding" />
      <stdlib name="time" purpose="Timeout and duration handling" />
      <stdlib name="log/slog" purpose="Structured logging" />
      <stdlib name="fmt" purpose="Error formatting" />
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architectural">ADR-001: Use net/http standard library only, no external HTTP frameworks</constraint>
    <constraint type="architectural">ADR-003: Explicit error returns with context wrapping, no exceptions/panics</constraint>
    <constraint type="architectural">ADR-004: Use log/slog for all logging</constraint>
    <constraint type="architectural">ADR-005: Minimal external dependencies - stdlib only for this story</constraint>
    <constraint type="pattern">Context propagation: All I/O functions must accept context.Context as first parameter</constraint>
    <constraint type="pattern">Dependency injection via constructor, not global state</constraint>
    <constraint type="pattern">Nil logger check: If logger is nil, use slog.Default()</constraint>
    <constraint type="naming">User-Agent value must be exactly "defillama-extract/1.0"</constraint>
    <constraint type="testing">Tests co-located in *_test.go files</constraint>
    <constraint type="testing">Use httptest.NewServer for HTTP client tests</constraint>
  </constraints>

  <interfaces>
    <interface name="NewClient" kind="constructor" signature="func NewClient(cfg *config.APIConfig, logger *slog.Logger) *Client" path="internal/api/client.go" />
    <interface name="doRequest" kind="method" signature="func (c *Client) doRequest(ctx context.Context, url string, target any) error" path="internal/api/client.go" />
    <interface name="config.APIConfig" kind="struct" signature="type APIConfig struct { OraclesURL string; ProtocolsURL string; Timeout time.Duration; MaxRetries int; RetryDelay time.Duration }" path="internal/config/config.go" />
    <interface name="logging.Setup" kind="function" signature="func Setup(cfg config.LoggingConfig) *slog.Logger" path="internal/logging/logging.go" />
  </interfaces>

  <tests>
    <standards>Use Go stdlib testing package with table-driven tests. Mock server tests use httptest.NewServer. Test files co-located with implementation (*_test.go). Coverage target: 90%+ for client.go. All error paths must be tested.</standards>
    <locations>
      <location>internal/api/client_test.go</location>
      <location>testdata/ (for test fixtures)</location>
    </locations>
    <ideas>
      <idea ac="1" desc="TestNewClient_SetsTimeout: Verify httpClient.Timeout matches cfg.Timeout" />
      <idea ac="2" desc="TestDoRequest_SetsUserAgent: Mock server captures and verifies User-Agent header is defillama-extract/1.0" />
      <idea ac="3" desc="TestDoRequest_Timeout: Mock server sleeps beyond timeout, verify error contains timeout indication" />
      <idea ac="4" desc="TestNewClient_NilLogger: Pass nil logger, verify slog.Default() is used" />
      <idea ac="4" desc="TestNewClient_StoresConfig: Verify all config fields are stored correctly in Client" />
      <idea ac="5" desc="TestDoRequest_ContextCancellation: Cancel context during request, verify context.Canceled error" />
      <idea ac="2,4" desc="TestDoRequest_JSONDecode: Mock server returns JSON, verify target struct populated correctly" />
      <idea ac="2" desc="TestDoRequest_NonSuccessStatus: Mock server returns 500, verify error returned" />
    </ideas>
  </tests>
</story-context>
